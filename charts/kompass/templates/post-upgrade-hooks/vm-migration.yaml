{{ if .Values.victoriaMetricsMigration.enabled }}
{{- $globalValues := .Values.global | default (dict) -}}
{{- $migrationValues := .Values.victoriaMetricsMigration | default (dict) -}}
{{- $migrationPodAnnotations := include "kompass.workload.resolveMap" (dict "global" $globalValues "component" $migrationValues "key" "podAnnotations") | fromYaml -}}
{{- $migrationPodLabels := include "kompass.workload.resolveMap" (dict "global" $globalValues "component" $migrationValues "key" "podLabels") | fromYaml -}}
{{- $migrationAffinity := include "kompass.workload.resolveMap" (dict "global" $globalValues "component" $migrationValues "key" "affinity") | fromYaml -}}
{{- $migrationImagePullSecrets := include "kompass.workload.resolveList" (dict "global" $globalValues "component" $migrationValues "key" "imagePullSecrets") | fromYamlArray -}}
{{- $migrationPodSecurityContext := include "kompass.workload.resolveMap" (dict "global" $globalValues "component" $migrationValues "key" "podSecurityContext") | fromYaml -}}
{{- $migrationSecurityContext := include "kompass.workload.resolveContainerSecurityContext" (dict "global" $globalValues "component" $migrationValues) | fromYaml -}}
{{- $migrationTopologySpreadConstraints := include "kompass.workload.resolveList" (dict "global" $globalValues "component" $migrationValues "key" "topologySpreadConstraints") | fromYamlArray -}}
{{- $migrationAutomountServiceAccountToken := include "kompass.workload.resolveBool" (dict "global" $globalValues "component" $migrationValues "key" "automountServiceAccountToken") | trim -}}
{{- $migrationRuntimeClassName := include "kompass.workload.resolveString" (dict "global" $globalValues "component" $migrationValues "key" "runtimeClassName") | trim -}}
{{- $migrationServiceAccountName := index $migrationValues "serviceAccountName" | default "" | trim -}}
---
# The migration job
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "kompass.name" . }}-vm-migration
  annotations:
    "helm.sh/hook": post-upgrade
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
spec:
  ttlSecondsAfterFinished: 300  # Keep the job for 5 minutes after failure for debugging
  template:
    metadata:
      name: {{ include "kompass.name" . }}-vm-migration
      {{- if $migrationPodAnnotations }}
      annotations:
{{ toYaml $migrationPodAnnotations | nindent 8 }}
      {{- end }}
      {{- $migrationDefaultPodLabels := dict "app.kubernetes.io/name" (printf "%s-vm-migration" (include "kompass.name" .)) "app.kubernetes.io/instance" .Release.Name }}
      {{- $migrationResolvedPodLabels := mergeOverwrite (deepCopy $migrationDefaultPodLabels) $migrationPodLabels }}
      labels:
{{ toYaml $migrationResolvedPodLabels | nindent 8 }}
    spec:
      {{- if ne $migrationAutomountServiceAccountToken "null" }}
      automountServiceAccountToken: {{ $migrationAutomountServiceAccountToken }}
      {{- end }}
      {{- if $migrationImagePullSecrets }}
      imagePullSecrets:
{{ toYaml $migrationImagePullSecrets | nindent 8 }}
      {{- end }}
      {{- if $migrationPodSecurityContext }}
      securityContext:
{{ toYaml $migrationPodSecurityContext | nindent 8 }}
      {{- end }}
      {{- if $migrationRuntimeClassName }}
      runtimeClassName: {{ $migrationRuntimeClassName }}
      {{- end }}
      {{- if $migrationServiceAccountName }}
      serviceAccountName: {{ $migrationServiceAccountName }}
      {{- end }}
      {{- if $migrationAffinity }}
      affinity:
{{ toYaml $migrationAffinity | nindent 8 }}
      {{- end }}
      {{- if $migrationTopologySpreadConstraints }}
      topologySpreadConstraints:
{{ toYaml $migrationTopologySpreadConstraints | nindent 8 }}
      {{- end }}
      containers:
      - name: vm-migration
        image: {{ .Values.victoriaMetricsMigration.image.registry }}/{{ .Values.victoriaMetricsMigration.image.repository }}:{{ .Values.victoriaMetricsMigration.image.tag }}
        {{- if $migrationSecurityContext }}
        securityContext:
{{ toYaml $migrationSecurityContext | nindent 10 }}
        {{- end }}
        args:
          - vm-native
          - --vm-native-src-addr={{ include "kompass.victoria-metrics.vmsingle.url" . }}
          - --vm-native-dst-addr={{ include "kompass.victoria-metrics.vmcluster.vminsert.url" . }}
          - --vm-native-filter-time-start=now-7d
          - --vm-native-step-interval=hour
      restartPolicy: Never
  backoffLimit: 0
{{- end }}
