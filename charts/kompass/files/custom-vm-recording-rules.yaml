{{- $methods := include "kompass.customReplicaAggregationMethods" . | fromYaml -}}
{{- $cpuMethods := get $methods "cpu" -}}
{{- $memoryMethods := get $methods "memory" -}}
groups:
  - name: custom_rules
    rules:
      - record: kompass_container_cpu_usage_max_rate
        expr: max(rate(container_cpu_usage_seconds_total{container!="", pod!=""}[1m]) * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_cpu_usage_p95_rate
        expr: quantile(0.95, rate(container_cpu_usage_seconds_total{container!="", pod!=""}[1m]) * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_cpu_usage_p85_rate
        expr: quantile(0.85, rate(container_cpu_usage_seconds_total{container!="", pod!=""}[1m]) * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_cpu_usage_custom1_rate
        expr: quantile({{ divf (float64 (get $cpuMethods "custom1")) 100 }}, rate(container_cpu_usage_seconds_total{container!="", pod!=""}[1m]) * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_cpu_usage_custom2_rate
        expr: quantile({{ divf (float64 (get $cpuMethods "custom2")) 100 }}, rate(container_cpu_usage_seconds_total{container!="", pod!=""}[1m]) * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_memory_usage_max
        expr: max(container_memory_working_set_bytes{container!="",pod!=""} * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_memory_usage_p95
        expr: quantile(0.95, container_memory_working_set_bytes{container!="",pod!=""} * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_memory_usage_p99
        expr: quantile(0.99, container_memory_working_set_bytes{container!="",pod!=""} * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_memory_usage_custom1
        expr: quantile({{ divf (float64 (get $memoryMethods "custom1")) 100 }}, container_memory_working_set_bytes{container!="",pod!=""} * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_memory_usage_custom2
        expr: quantile({{ divf (float64 (get $memoryMethods "custom2")) 100 }}, container_memory_working_set_bytes{container!="",pod!=""} * on (pod, container) group_left (resource_id, created_by_name, created_by_kind, namespace) max(kompass_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (pod, container) max(kompass_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_cpu_usage_sum_rate
        expr: sum(rate(container_cpu_usage_seconds_total{container!="", pod!=""}[1m]) * on (namespace, pod, container) group_left (resource_id, created_by_name, created_by_kind) max(kompass_insights_pod_info) by (container, pod, resource_id, created_by_name, created_by_kind, namespace)) by (container, resource_id, created_by_name, created_by_kind, namespace) or on (namespace, pod, container) max(kompass_insights_pod_info) by (container, resource_id, created_by_name, created_by_kind, namespace) * 0
      - record: kompass_container_resource_requests_median
        expr: quantile(0.5, kube_pod_container_resource_requests * on(namespace,pod,container) group_left(resource_id,created_by_name,created_by_kind) max(kompass_insights_pod_info) by(container,pod,resource_id,created_by_name,created_by_kind,namespace)) by(container,resource_id,created_by_name,created_by_kind,namespace,resource) or on(namespace,pod,container) (max(kompass_insights_pod_info) by(container,resource_id,created_by_name,created_by_kind,namespace) * 0)
      - record: kompass_hpa_workload_cpu_usage_rate
        expr: sum(rate(container_cpu_usage_seconds_total{container!="",pod!=""}[1m]) * on(pod,container) group_left (resource_id,created_by_name,created_by_kind,namespace) max (kompass_pod_info) by (container,pod,resource_id,created_by_name,created_by_kind,namespace) * on (namespace, created_by_name) group_left (scaletargetref_kind, horizontalpodautoscaler) label_replace(label_replace(max by (namespace, scaletargetref_name, scaletargetref_kind, horizontalpodautoscaler) (label_lowercase(kube_horizontalpodautoscaler_info, "scaletargetref_kind")), "created_by_kind", "$1", "scaletargetref_kind", "(.*)"), "created_by_name", "$1", "scaletargetref_name", "(.*)")) by (resource_id, created_by_kind, created_by_name, namespace)
      - record: kompass_hpa_workload_memory_usage_rate
        expr: sum(container_memory_working_set_bytes{container!="",pod!=""}[1m] * on(pod,container) group_left (resource_id,created_by_name,created_by_kind,namespace) max (kompass_pod_info) by (container,pod,resource_id,created_by_name,created_by_kind,namespace) * on (namespace, created_by_name) group_left (scaletargetref_kind, horizontalpodautoscaler) label_replace(label_replace(max by (namespace, scaletargetref_name, scaletargetref_kind, horizontalpodautoscaler) (label_lowercase(kube_horizontalpodautoscaler_info, "scaletargetref_kind")), "created_by_kind", "$1", "scaletargetref_kind", "(.*)"), "created_by_name", "$1", "scaletargetref_name", "(.*)")) by (resource_id, created_by_kind, created_by_name, namespace)
      - record: kompass_pod_startup_time
        expr: (kube_pod_status_ready_time - kube_pod_created) * on (pod, namespace) group_left (created_by_name, created_by_kind, resource_id) max by (pod, namespace, created_by_name, created_by_kind, resource_id) (kompass_pod_info)
      - record: kompass_rs_initial_minus_desired
        expr: max by (resource_id, pod, resource_type) (kompass_pod_info{status="running"} * on(resource_id, pod) group_left(resource_type) max by (resource_id, pod, resource_type) (last_over_time(kompass_rs_initial_minus_desired{pod!=""}[1h])))
